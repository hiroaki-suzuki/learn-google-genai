# PRD: 環境変数ファイル管理改修とGit履歴クリーンアップ

## 概要

映画メタ情報の品質評価・改善ループシステムにおいて、機密情報を含む環境変数ファイルがGit履歴に含まれてしまっている問題を解決します。セキュリティ向上のため、`.env.example`以外の環境変数ファイルをGit管理対象外とし、既存のGit履歴から`.env.test`を完全に削除します。また、スコア閾値の設定を適切な値に更新します。

## 目標

- `.env`と`.env.test`をGit管理対象外にする
- Git履歴から`.env.test`を完全に削除し、機密情報の漏洩リスクを排除する
- コミットメッセージを維持したまま履歴をクリーンアップする
- スコア閾値をテスト環境は3.5、本番環境は4.5に統一する
- ローカルリポジトリのみで作業を完結させ、リモートへの影響を最小化する

## ユーザーストーリー

### US-001: .gitignoreに環境変数ファイルを追加

**説明:** 開発者として、機密情報を含む環境変数ファイルが誤ってGitにコミットされないよう、`.gitignore`に適切な除外パターンを追加したい。

**受入基準:**

- [x] `.gitignore`に`app/.env*`パターンを追加
- [x] `.gitignore`に`!app/.env.example`パターンを追加（除外ルール）
- [x] `git check-ignore -v app/.env.test`で除外されることを確認
- [x] `git check-ignore -v app/.env.example`で除外されない（管理対象のまま）ことを確認
- [x] `git check-ignore -v app/.env`で除外されることを確認
- [x] `git check-ignore -v app/.env.prod`で除外されることを確認
- [x] `git status`で`.env`と`.env.test`がuntracked filesとして表示されないことを確認する
- [x] 品質チェック（フォーマット、Lint、型チェック）が通過すること
- [x] コンソール出力で変更が正しく反映されていることを確認する

---

### US-002: Git履歴から.env.testを完全に削除

**説明:** 開発者として、過去のコミット履歴に含まれている`.env.test`を完全に削除し、機密情報の漏洩リスクを排除したい。

**受入基準:**

- [x] `git filter-branch`または`git filter-repo`を使用して、全コミット履歴から`app/.env.test`を削除する
- [x] コミットメッセージは元の内容を維持する
- [x] `git log --all --oneline -- app/.env.test`で結果が空になることを確認する
- [x] `git reflog expire --expire=now --all`でreflogをクリーンアップする
- [x] `git gc --prune=now --aggressive`でガベージコレクションを実行する
- [x] リモートリポジトリへのpushは行わない（ローカルのみで作業完結）
- [x] コンソール出力で履歴クリーンアップが正しく完了したことを確認する

**注意事項:**
- この作業は破壊的な操作のため、実行前にバックアップを推奨
- チーム開発の場合は事前に関係者へ通知が必要（本件はローカルのみのため対象外）

---

### US-003: .env.exampleのスコア閾値を更新

**説明:** 開発者として、環境変数のテンプレートファイルに適切なスコア閾値のデフォルト値を設定し、新規セットアップ時の指針を明確にしたい。

**受入基準:**

- [x] `.env.example`内の`QUALITY_SCORE_THRESHOLD`を`4.5`に設定する
- [x] スコア閾値の有効範囲が0.0〜5.0であることをコメントで明記する
- [x] 設定例として「テスト環境: 3.5、本番環境: 4.5」をコメントで追加する
- [x] 品質チェック（フォーマット、Lint、型チェック）が通過すること
- [x] コンソール出力で変更が正しく反映されていることを確認する

---

### US-004: .env.testファイルの再作成

**説明:** 開発者として、Git管理対象外となった`.env.test`ファイルをテスト環境用の適切な設定で再作成したい。

**受入基準:**

- [x] `app/.env.test`ファイルを作成する（Git管理対象外）
- [x] `.env.example`の内容をベースにコピーする
- [x] `QUALITY_SCORE_THRESHOLD`を`3.5`に設定する
- [x] `ENV`変数を`test`に設定する（存在する場合）
- [x] `git status`で`.env.test`がuntracked filesとして表示されないことを確認する
- [x] コンソール出力で変更が正しく反映されていることを確認する

---

### US-005: .envファイルのスコア閾値を更新

**説明:** 開発者として、本番環境用の`.env`ファイルのスコア閾値を適切な値に更新したい。

**受入基準:**

- [x] `app/.env`ファイルの`QUALITY_SCORE_THRESHOLD`を`4.5`に設定する
- [x] ファイルがGit管理対象外であることを確認する（`git status`で表示されない）
- [x] コンソール出力で変更が正しく反映されていることを確認する

---

### US-006: 動作確認とテスト実行

**説明:** 開発者として、環境変数の設定変更が正しく反映され、アプリケーションが正常に動作することを確認したい。

**受入基準:**

- [x] `cd app && uv run pytest`でテストが全て通過することを確認する
- [x] テスト実行時に`ENV=test`が自動設定され、`.env.test`が読み込まれることを確認する
- [x] テスト環境でのスコア閾値が3.5として機能することを確認する
- [x] 本番環境（`uv run main.py`）でのスコア閾値が4.5として機能することを確認する
- [x] 品質チェック（フォーマット、Lint、型チェック）が通過すること
- [x] テストがすべて合格すること
- [x] テストカバレッジが基準値を満たすこと
- [x] コンソール出力で正しいスコア閾値が使用されていることを確認する

## 対象外項目

- リモートリポジトリへのforce pushは実施しない
- 他の環境変数ファイル（`.env.dev`、`.env.prod`など）の作成は行わない
- スコア閾値の値の妥当性検証やチューニングは行わない
- CI/CDパイプラインでの環境変数管理方法の変更は行わない
- 既存の`.env`ファイルのバックアップ作成は行わない（ユーザー判断に委ねる）

## 技術的考慮事項

### Git履歴改変ツールの選択

- **git filter-branch**: 標準搭載だが非推奨
- **git filter-repo**: 推奨ツールだがインストールが必要
- 環境に応じて利用可能なツールを選択する

### 環境変数の優先順位

現在の実装では以下の優先順位で環境変数ファイルが読み込まれる:
1. `ENV=test`の場合: `.env.test`
2. `ENV=production`または未設定: `.env`
3. pytestの場合: 自動的に`.env.test`

### バックアップの推奨

Git履歴改変は破壊的な操作のため、以下のバックアップを推奨:
```bash
git bundle create backup.bundle --all
```

復元が必要な場合:
```bash
git clone backup.bundle restored-repo
```
