# 進捗記録

## 得られた知見

（実装過程で発見されたパターンや知見）

---

## イテレーション 1 - メタデータ品質評価用のデータモデルを定義（US-001）
- 実装内容: MetadataFieldScore、MetadataEvaluationResult、RefinementHistoryEntry、MetadataRefinementResult、MetadataEvaluationOutputの5つのモデルを追加
- 変更したファイル: app/movie_metadata/models.py、PRD.md
- 今後のイテレーションに向けた学習事項：
  - llm_judge/models.pyの既存パターン（AspectScore、DirectAssessmentResult、SelfRefinementResult）を参考にすると、一貫性のあるモデル設計ができる
  - Pydanticのgeとleバリデータを使用して、スコア範囲（0.0〜5.0）を強制できる
  - descriptionフィールドが長い場合は、括弧でくくって複数行に分割すると88文字制限に対応できる
  - LLM出力用のスキーマ（MetadataEvaluationOutput）は、実際の結果モデル（MetadataEvaluationResult）と分けることで、構造化出力の柔軟性を確保できる
---

## イテレーション 2 - メタデータ評価機能を実装（US-002）
- 実装内容: MetadataEvaluatorクラスとメタデータ評価用プロンプトテンプレートを追加
- 変更したファイル:
  - app/movie_metadata/prompts.py（新規作成）
  - app/movie_metadata/evaluator.py（新規作成）
  - PRD.md
- 今後のイテレーションに向けた学習事項：
  - llm_judge/direct_assessment.pyのパターン（プロンプト構築→API呼び出し→パース→結果構築）を踏襲することで、一貫性のある実装ができる
  - GenAIClientはコンテキストマネージャーとして使用するのが推奨（with文でリソース管理を自動化）
  - プロンプトテンプレートは別ファイル（prompts.py）に分離し、プロンプト構築関数を提供すると保守性が高い
  - 88文字制限を超える場合、計算結果を別変数に分割するか、ログメッセージを複数行に分割する
  - プロンプトテンプレート内の長い行は、意味の区切りで改行を入れて対応できる
---

## イテレーション 3 - メタデータ改善提案生成機能を実装（US-003）
- 実装内容: ImprovementProposerクラスとメタデータ改善提案用プロンプトテンプレートを追加
- 変更したファイル:
  - app/movie_metadata/prompts.py（改善提案用プロンプト追加、必要なインポート追加）
  - app/movie_metadata/improvement_proposer.py（新規作成）
  - PRD.md
- 今後のイテレーションに向けた学習事項：
  - prompts.pyで型を使用する関数を定義する場合、必要な型をインポートする必要がある
  - 改善提案のプロンプトでは、評価結果のサマリーを構築して含めることで、LLMが具体的な改善提案を生成しやすくなる
  - overall_statusが"pass"の場合は、改善提案を生成せずに早期リターンすることで、API呼び出しを節約できる
  - プロンプトテンプレートには、出力形式の例を含めることで、LLMの出力品質が向上する
---

## イテレーション 4 - メタデータ再取得・改善機能を実装（US-004）
- 実装内容: MovieMetadataFetcherにfetch_with_improvementメソッドを追加
- 変更したファイル:
  - app/movie_metadata/prompts.py（build_metadata_fetch_prompt関数を追加）
  - app/movie_metadata/metadata_fetcher.py（共通ロジック抽出と新メソッド追加）
  - PRD.md
- 今後のイテレーションに向けた学習事項：
  - 共通ロジックは内部メソッド（_fetch_metadata）に抽出することで、コードの重複を避けられる
  - プロンプト構築関数は、オプション引数を使って基本版と改善版を統一的に扱える
  - 改善指示は独立したセクションとしてプロンプトに追加することで、LLMが改善点を明確に理解できる
  - 既存のAPIを壊さずに新機能を追加する際は、既存メソッドを内部メソッドを使う形に書き換えることで、後方互換性を保てる
---

## イテレーション 5 - 評価・改善ループ統合機能を実装（US-005）
- 実装内容: MetadataRefinerクラスを実装し、評価→改善提案→再取得のサイクルを自動化
- 変更したファイル:
  - app/movie_metadata/refiner.py（新規作成）
  - PRD.md
- 今後のイテレーションに向けた学習事項：
  - 複数のクラスを統合する際は、各クラスをコンポジションで保持することで、責任を明確に分離できる
  - GenAIClientをコンテキストマネージャーとして使用し、その中でMovieMetadataFetcherを初期化することで、リソース管理を効率化できる
  - イテレーションループでは、初回と2回目以降で処理を分岐させ、履歴を活用して改善を進められる
  - rate_limit_sleepは、API呼び出しごと（メタデータ取得後、評価後、改善提案後）に適用することで、レート制限エラーを回避できる
  - 終了条件（成功/最大イテレーション到達）を明確に分離し、それぞれで適切なログとステータスを返すことで、デバッグと結果の解釈が容易になる
  - 改善提案は次のイテレーションで使用するため、ループの最後で生成する（最終イテレーション後は不要なので生成しない）
---

## イテレーション 6 - 結果出力機能を実装（US-006）
- 実装内容: RefinementResultWriterクラスを実装し、メタデータ改善結果をJSON形式で保存する機能を追加
- 変更したファイル:
  - app/movie_metadata/refinement_writer.py（新規作成）
  - PRD.md
- 今後のイテレーションに向けた学習事項：
  - Pydanticモデルの`model_dump()`メソッドを使用することで、ネストした構造も含めて簡単にJSON変換できる
  - ファイル名にタイトルを含める場合は、`_sanitize_filename()`メソッドで安全な文字のみに変換する必要がある
  - タイムスタンプは`datetime.now().strftime("%Y%m%d_%H%M%S")`形式で生成すると、ソート可能なファイル名になる
  - JSON出力時は`ensure_ascii=False`と`indent=2`を指定することで、日本語が読みやすく整形された形式で保存できる
  - 出力ディレクトリが存在しない場合に備えて、`mkdir(parents=True, exist_ok=True)`で自動作成することで、実行時エラーを防げる
  - ファイル名の長さ制限（50文字程度）を設けることで、OSのファイル名長制限に対応できる
---
