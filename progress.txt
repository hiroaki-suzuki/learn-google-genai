# 進捗記録

## イテレーション 1 - US-001: CSV_FILENAMEの環境変数サポートを追加
- 実装内容:
  - `config.py`に`csv_filename`フィールドを追加（環境変数`CSV_FILENAME`から読み込み）
  - `field_validator`を使用して、`CSV_FILENAME`が設定されている場合は`data/{CSV_FILENAME}`を使用し、未設定の場合はデフォルト値`data/movies_test3.csv`を使用するように実装
  - `tests/test_config.py`を新規作成し、5つのテストケースを追加（100%カバレッジ）
  - テストでは、環境変数の設定/未設定、パスの自動生成、フィールドの存在確認などをカバー

- 変更したファイル:
  - `app/config.py`: `csv_filename`フィールドと`field_validator`を追加
  - `app/tests/test_config.py`: 新規作成
  - `app/tests/test_genai_client.py`: Ruffのリント警告（SIM117）に対応してwith文を統合

- 今後のイテレーションに向けた学習事項:
  - Pydantic SettingsのFieldでは`validation_alias`を使用して環境変数名を指定できる
  - `field_validator`の`mode="before"`を使用すると、バリデーション前の値にアクセスできる
  - `info.data.get()`を使用して他のフィールドの値を参照できる
  - テストでは`patch.dict("os.environ", {...}, clear=True)`を使用して環境変数を安全にモックできる
  - `.env.example`ファイルの編集には権限が必要な場合があるため、代替手段を検討する必要がある

---

## 得られた知見

（実装過程で発見されたパターンや知見）

---
## イテレーション 2 - US-002: 複数レコード結果を保存するデータモデルの拡張
- 実装内容
- `BatchRefinementResult`モデルを追加し、バッチ処理の統計情報とエラー情報を保持できるようにした
- `BatchRefinementResult`の単体テストを追加し、成功/エラーケースを検証した
- 変更したファイル
- `app/movie_metadata/models.py`
- `app/tests/test_models.py`
- 今後のイテレーションに向けた学習事項：
- `BatchRefinementResult`の`errors`は`list[dict[str, str]]`で保持し、映画タイトルとエラーメッセージを格納する
- モデル追加時は既存テストのフィクスチャを再利用するとテストが簡潔になる
---
## イテレーション 3 - US-003: タイムスタンプ付きファイル名でJSON出力する機能を実装
- 実装内容
- `RefinementResultWriter.write_batch()`を追加し、バッチ結果をタイムスタンプ付きファイル名でJSON出力するようにした
- `write_batch()`の単体テストを追加し、ファイル名形式・ディレクトリ作成・JSON内容を検証した
- 変更したファイル
- `app/movie_metadata/refinement_writer.py`
- `app/tests/test_refinement_writer.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- タイムスタンプ依存のテストは`datetime`のモックで固定値にすると安定する
- バッチJSON出力は`model_dump()`をそのまま使うと構造が揃う
---
## イテレーション 4 - US-004: 複数レコードのループ処理と進捗表示を実装
- 実装内容
- `main_refine.py`でCSVの全レコードをループ処理し、進捗ログと対象映画のログを出力するようにした
- 処理開始時刻を記録し、総処理時間をログ出力するようにした
- `MetadataRefinementResult`のリストに各レコードの結果を蓄積するようにした
- 変更したファイル
- `app/main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- 進捗ログは処理開始前に出力することで実行状況が把握しやすい
- バッチ処理の総時間計測は`time.perf_counter()`で安定して測定できる
---
## イテレーション 5 - US-004: 複数レコードのループ処理と進捗表示を実装
- 実装内容
- PRDのチェックリストで重複して未完了になっていた項目を完了済みに更新した
- 変更したファイル
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- PRDの重複チェックは実装漏れの原因になるため、完了項目は確実に更新する
---
## イテレーション 6 - US-005: エラーハンドリングとエラーサマリーの実装
- 実装内容
- `main_refine.py`にレコード単位の`try-except`を追加し、エラーを記録して処理を継続するようにした
- `BatchRefinementResult`を生成し、`write_batch()`でバッチ結果を保存するようにした
- エラー件数とタイトル一覧をログ出力するようにした
- `main_refine`のバッチ処理挙動を検証するテストを追加した
- 変更したファイル
- `app/main_refine.py`
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- バッチ処理の統計は`BatchRefinementResult`にまとめて管理するとテストが簡潔になる
- 例外系のテストは`refine`の`side_effect`で成功/失敗を混在させると実践的
---
## イテレーション 7 - US-006: CSV_FILENAMEの読み込み確認
- 実装内容
- `main_refine`の統合テストを追加し、`CSV_FILENAME`環境変数がCSV読み込みパスに反映されることを確認した
- テストで`GEMINI_API_KEY`も環境変数として設定し、`AppConfig`の必須値を満たすようにした
- 変更したファイル
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- `AppConfig`をそのまま使う統合テストでは`GEMINI_API_KEY`を必ず設定する
- `CSVReader.read`の呼び出し引数を検証すると、環境変数の反映確認が簡潔になる
---
## イテレーション 8 - US-006: 複数レコードCSVの全処理確認
- 実装内容
- `movies.csv`の全レコードを読み込み、処理件数分`refine`が呼ばれることを検証する統合テストを追加した
- 変更したファイル
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- 実CSVを使った統合テストでは、処理件数の期待値を`CSVReader`で取得すると安定する
---
## イテレーション 9 - US-006: タイムスタンプ付きJSON出力の確認
- 実装内容
- `main_refine`実行時にタイムスタンプ付きのバッチ結果ファイルが生成されることを検証する統合テストを追加した
- 変更したファイル
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- タイムスタンプ依存の統合テストでは`datetime`をモンキーパッチして出力ファイル名を固定すると安定する
---
## イテレーション 10 - US-006: 生成されたJSONに全レコード結果を含むことの確認
- 実装内容
- バッチJSON出力に全レコード結果が含まれることを検証する統合テストを追加した
- 変更したファイル
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- バッチ出力の内容検証はJSONを読み戻して件数とタイトル集合を確認すると簡潔
---
## イテレーション 11 - US-006: 進捗ログ出力の確認
- 実装内容
- 進捗ログがレコードごとに出力されることを検証するテストを追加した
- 変更したファイル
- `app/tests/test_main_refine.py`
- `PRD.md`
- 今後のイテレーションに向けた学習事項：
- 進捗ログの検証は`caplog`でINFOログを収集し、期待文言の存在を確認すると簡潔
---
